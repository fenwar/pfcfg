#!/bin/bash

echo -n "Comparison of ${3}:"

#TMPROOT=/tmp
TMPROOT=${XDG_RUNTIME_DIR}/tmp/imgdiff

mkdir -p ${TMPROOT}

TMPPATH=${TMPROOT}/tmp_00_montage.png
TMP_OLD=${TMPROOT}/tmp_01_old-resized.png
TMP_NEW=${TMPROOT}/tmp_02_new-resized.png

# Default screen resolution values (might be overridden below)
VIEWER_WIDTH=1920
VIEWER_HEIGHT=1050

# Options for sxiv:
# zoom image to 100%, full screen, no status bar, scale down if needed.
SXIV_OPTS="-Z -f -b -sd"

# Check whether the image is new/deleted (one of the files will be /dev/null)
if [ "${1}" == "/dev/null" ] ; then
    echo "New image added."
    sxiv ${SXIV_OPTS} -g${VIEWER_WIDTH}x${VIEWER_HEIGHT}+1920+0 ${2}
elif [ "${2}" == "/dev/null" ] ; then
    echo "Image deleted."
    sxiv ${SXIV_OPTS} -g${VIEWER_WIDTH}x${VIEWER_HEIGHT}+1920+0 ${1}
else
    # Compare the images:


    # Note:
    # ${1} = $LOCAL (original version of image)
    # ${2} = $REMOTE (new version of image)

    # resize image from previous version to match current.
    OLD_SIZE=($(identify -format "%w %h" ${1}))
    NEW_SIZE=($(identify -format "%w %h" ${2}))

    echo -n "(${OLD_SIZE[@]} ${NEW_SIZE[@]})"

    if [[ "${OLD_SIZE[@]}" == "${NEW_SIZE[@]}" ]] ; then
        # The images are the same size, so we can compare them directly:
        cp "${1}" "${TMP_OLD}"
        cp "${2}" "${TMP_NEW}"
    else
        # The images are different sizes, so convert them first

        if [ ${OLD_SIZE[0]} -gt ${NEW_SIZE[0]} ] ; then
            MAX_WIDTH=${OLD_SIZE[0]}
        else
            MAX_WIDTH=${NEW_SIZE[0]}
        fi

        if [ ${OLD_SIZE[1]} -gt ${NEW_SIZE[1]} ] ; then
            MAX_HEIGHT=${OLD_SIZE[1]}
        else
            MAX_HEIGHT=${NEW_SIZE[1]}
        fi

        #echo OLD: ${OLD_SIZE[0]}x${OLD_SIZE[1]}, \
        #     NEW: ${NEW_SIZE[0]}x${NEW_SIZE[1]}, \
        #     Resizing to ${MAX_WIDTH}x${MAX_HEIGHT}

        convert -extent "${MAX_WIDTH}x${MAX_HEIGHT}" -background black ${1} ${TMP_OLD}
        convert -extent "${MAX_WIDTH}x${MAX_HEIGHT}" -background black ${2} ${TMP_NEW}
    fi

    compare ${TMP_OLD} ${TMP_NEW} \
            -metric AE \
            -highlight-color magenta \
            :- |\
        montage -geometry +0+0 ${TMP_OLD} - ${TMP_NEW} ${TMPPATH}

    # Echo a newline because compare doesn't
    # TODO fix the format output of compare
    echo

    # set up window geometry so the window is centred on the screen
    # TODO scrape desktop width out of xrandr or something:
    #DESKTOP_WIDTH=5760
    #VIEWER_WIDTH=$((MAX_WIDTH * 3))
    #VIEWER_X=$(((DESKTOP_WIDTH - VIEWER_WIDTH) / 2))
    #$((3840-288))   #span both big monitors
    #$((5760 - 288))    # centred except for my panel
    VIEWER_X=1920
    #echo attempting to set geometry as -g${VIEWER_WIDTH}x${VIEWER_HEIGHT}+${VIEWER_X}+0
    sxiv ${SXIV_OPTS} -g${VIEWER_WIDTH}x${VIEWER_HEIGHT}+${VIEWER_X}+0 -N"imgdiff" ${TMPROOT}/*.png
    #pqiv -P "0,0" -i -c --disable-scaling $TMPPATH
    #qiv -e -f $TMPPATH
    #ristretto $TMPPATH
    #xloadimage -fullscreen stdin
    #display -title "Image Diff: $1" -geometry +0+0 -resize 1920x $TMPPATH
fi

# Clean up temp dir
rm -r ${TMPROOT}
