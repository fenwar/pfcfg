#!/bin/bash

echo Comparison of ${3}

#TMPROOT=/tmp
TMPROOT=${XDG_RUNTIME_DIR}/tmp/imgdiff

mkdir -p ${TMPROOT}

TMPPATH=${TMPROOT}/tmp_montage.png
TMP_OLD=${TMPROOT}/old-resized.png
TMP_NEW=${TMPROOT}/new-resized.png


# Note:
# ${1} = $LOCAL (original version of image)
# ${2} = $REMOTE (new version of image)

# resize image from previous version to match current.
OLD_SIZE=($(identify -format "%w %h" ${1}))
NEW_SIZE=($(identify -format "%w %h" ${2}))

if [ ${OLD_SIZE[0]} -gt ${NEW_SIZE[0]} ] ; then
    MAX_WIDTH=${OLD_SIZE[0]}
else
    MAX_WIDTH=${NEW_SIZE[0]}
fi

if [ ${OLD_SIZE[1]} -gt ${NEW_SIZE[1]} ] ; then
    MAX_HEIGHT=${OLD_SIZE[1]}
else
    MAX_HEIGHT=${NEW_SIZE[1]}
fi

#echo OLD: ${OLD_SIZE[0]}x${OLD_SIZE[1]}, \
#     NEW: ${NEW_SIZE[0]}x${NEW_SIZE[1]}, \
#     Resizing to ${MAX_WIDTH}x${MAX_HEIGHT}

convert -extent "${MAX_WIDTH}x${MAX_HEIGHT}" -background black ${1} ${TMP_OLD}
convert -extent "${MAX_WIDTH}x${MAX_HEIGHT}" -background black ${2} ${TMP_NEW}

compare ${TMP_OLD} ${TMP_NEW} -metric RMSE -subimage-search -highlight-color magenta :- |\
    montage -geometry +0+0 ${TMP_OLD} - ${TMP_NEW} ${TMPPATH}

sxiv -Z -F -g3600x1100+0+0 -N"hello" ${TMPPATH}
#pqiv -P "0,0" -i -c --disable-scaling $TMPPATH
#qiv -e -f $TMPPATH
#ristretto $TMPPATH
#xloadimage -fullscreen stdin
#display -title "Image Diff: $1" -geometry +0+0 -resize 1920x $TMPPATH

rm $TMPPATH

# TODO
# cope with either side being empty
# better image viewer than display?
# resize the window to span displays where necessary
# Make this only run on git difftool, not git diff. (Use exif for that)
